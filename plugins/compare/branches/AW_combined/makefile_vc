NAME = Compare

!ifndef DEBUG
DIRNAME=final
!else
DIRNAME=debug
!endif                   

!ifdef WIDE
DIRSUFF = W
!endif

!IF "$(CPU)" == "AMD64"
DIRBIT = 64
!ELSE
DIRBIT = 32
!ENDIF
OUTDIR = $(DIRNAME).$(DIRBIT)$(DIRSUFF).vc

OBJDIR = $(OUTDIR)\obj
COMMON = ..\common
!ifndef WIDE
COMINC = $(COMMON)\ascii
!else
COMINC = $(COMMON)\unicode
CPP_WIDE = /DUNICODE /D_UNICODE
RC_WIDE = /dUNICODE
!endif
DLLNAME = $(NAME).dll
DLLFULLNAME = $(OUTDIR)\$(DLLNAME)
!ifndef WIDE
DEF = $(NAME).vc.def
!else
DEF = $(NAME)W.vc.def
!endif
MAP = $(OUTDIR)\$(NAME).map

!ifndef DEBUG
CPP_OPT=/DNDEBUG /O1i
!else
PDBNAME="$(OUTDIR)\$(NAME).pdb"
CPP_OPT=/DDEBUG /Od /Fd$(PDBNAME)
!endif

!IF "$(CPU)" == "AMD64"
LIBS = $(COMMON)\libCRT64.lib chkstk.obj kernel32.lib user32.lib gdi32.lib advapi32.lib
CPP_PROJ=/nologo /c /W3 /Gy /GF /Zp8 /J /Wp64 /GS- /Gr /GR- /EHs-c- /LD /Fo"$(OBJDIR)\\" /I"$(COMMON)" /I"$(COMINC)" $(CPP_WIDE) /D_CRT_SECURE_NO_WARNINGS /D_CRT_NONSTDC_NO_WARNINGS
ULOUT=-Tpd+
!ELSE
LIBS = $(COMMON)\libCRT.lib kernel32.lib user32.lib gdi32.lib advapi32.lib libcmt.lib
CPP_PROJ=/nologo /c /W3 /Gy /GF /J /Gr /GS- /GR- /EHs-c- /LD /Fo"$(OBJDIR)\\" /I"$(COMMON)" /I"$(COMINC)" $(CPP_WIDE) /D_CRT_SECURE_NO_WARNINGS /D_CRT_NONSTDC_NO_WARNINGS
ULOUT=-Tpd -Re
!ENDIF

!ifndef ULINK
LNK=link.exe
LINK_DEBUG=/pdb:$(PDBNAME)
CPP_DBGOPT=/Zi $(CPP_OPT)
LINK_FLAGS=/nologo /dll /release /merge:.rdata=.text /opt:nowin98 /noentry /nodefaultlib /def:"$(DEF)" /map:"$(MAP)" /out:"$(DLLFULLNAME)"
!else
LINK_DEBUG=-v
CPP_DBGOPT=/Z7 $(CPP_OPT)
LNK=ulink.exe +-
LINK_FLAGS=-q $(ULOUT) -Gz -n -m- -Gh -Gh- -e- /ZD:"$(DEF)" /ZM:"$(MAP)" /ZO:"$(DLLFULLNAME)"
!endif

!ifndef DEBUG
!undef LINK_DEBUG
!undef CPP_DEBUG
!endif

LINK_OBJS = $(OBJDIR)\Compare.obj

RESS = $(OBJDIR)\$(NAME).res

ALL: $(OUTDIR) $(OBJDIR) $(DLLFULLNAME)

$(DLLFULLNAME) : $(LINK_OBJS) $(RESS)
	$(LNK) @<<
	$(LINK_FLAGS) $(LINK_DEBUG) $(LIBS) $(LINK_OBJS) $(RESS)
<<
	@copy /Y *.hlf $(OUTDIR) > nul
	@copy /Y *.lng $(OUTDIR) > nul

.cpp{$(OBJDIR)}.obj::
	cl @<<
	$(CPP_PROJ) $(CPP_DBGOPT) $<
<<

$(OBJDIR)\$(NAME).res: $(NAME).rc $(COMINC)\farversion.hpp
	@rc /I"$(COMINC)" $(RC_WIDE) /fo"$(OBJDIR)\$(NAME).res" $(NAME).rc

$(OBJDIR)\Compare.obj: Compare.cpp $(COMINC)\plugin.hpp

$(OBJDIR): $(OUTDIR)
	@if not exist "$(OBJDIR)\$(NULL)" mkdir "$(OBJDIR)"

$(OUTDIR):
	@if not exist "$(OUTDIR)\$(NULL)" mkdir "$(OUTDIR)"
