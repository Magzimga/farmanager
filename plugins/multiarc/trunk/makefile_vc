NAME = MultiArc

!ifdef WIDE
DIRSUFF = W
!endif

!IF "$(CPU)" == "AMD64"
DIRBIT = 64
!ELSE
DIRBIT = 32
!ENDIF
OUTDIR = final.$(DIRBIT)$(DIRSUFF).vc

OBJDIR = $(OUTDIR)\obj
COMMON = ..\common
!ifndef WIDE
COMINC = $(COMMON)\ascii
!else
COMINC = $(COMMON)\unicode
!endif
DLLNAME = $(NAME).dll
DLLFULLNAME = $(OUTDIR)\$(DLLNAME)
DEF = $(NAME).def
MAP = $(OUTDIR)\$(NAME).map

!IF "$(CPU)" == "AMD64"
LIBS = $(COMMON)\libCRT64.lib chkstk.obj kernel32.lib user32.lib gdi32.lib advapi32.lib
CPP_PROJ=/nologo /D_FAR_USE_FARFINDDATA /c /Ox /Zp8 /J /Wp64 /GS- /Gr /GR- /EHs-c- /LD /Fo"$(OBJDIR)\\" /I"$(COMMON)" /I"$(COMINC)"
!ELSE
LIBS = $(COMMON)\libCRT.lib kernel32.lib user32.lib gdi32.lib advapi32.lib libcmt.lib
CPP_PROJ=/nologo /D_FAR_USE_FARFINDDATA /c /Zp1 /Ox /J /Gr /GR- /EHs-c- /LD /Fo"$(OBJDIR)\\" /I"$(COMMON)" /I"$(COMINC)"
!ENDIF

LINK_FLAGS=/nologo /dll /release /merge:.rdata=.text /opt:nowin98 /noentry /nodefaultlib /def:"$(DEF)" /map:"$(MAP)" /out:"$(DLLFULLNAME)" $(LIBS)

LINK_OBJS = $(OBJDIR)\MultiArc.obj \
$(OBJDIR)\ArcCfg.obj \
$(OBJDIR)\ArcCmd.obj \
$(OBJDIR)\ArcGet.obj \
$(OBJDIR)\ArcMix.obj \
$(OBJDIR)\ArcPlg.obj \
$(OBJDIR)\ArcProc.obj \
$(OBJDIR)\ArcPut.obj \
$(OBJDIR)\ArcRead.obj \
$(OBJDIR)\ArcReg.obj \
$(OBJDIR)\global.obj \
$(OBJDIR)\$(NAME).res

ALL: $(OUTDIR) $(OBJDIR) $(DLLFULLNAME) fmt

$(DLLFULLNAME) : $(LINK_OBJS)
	link @<<
	$(LINK_FLAGS) $(LINK_OBJS)
<<
	@copy /Y *.lng $(OUTDIR) > nul
	@copy /Y *.hlf $(OUTDIR) > nul

.cpp{$(OBJDIR)}.obj::
	cl @<<
	$(CPP_PROJ) $<
<<

$(OBJDIR)\$(NAME).res: $(NAME).rc $(COMINC)\farversion.hpp
	@rc /I"$(COMINC)" /fo"$(OBJDIR)\$(NAME).res" $(NAME).rc

$(OBJDIR): $(OUTDIR)
	@if not exist "$(OBJDIR)\$(NULL)" mkdir "$(OBJDIR)"

$(OUTDIR):
	@if not exist "$(OUTDIR)\$(NULL)" mkdir "$(OUTDIR)"

fmt:
	@cd libpcre
	$(MAKE) /f makefile_lib_vc
	@cd ..
	$(MAKE) /f makefile_fmt_vc FMT=Custom
	$(MAKE) /f makefile_fmt_vc FMT=Ace
	$(MAKE) /f makefile_fmt_vc FMT=Arc
	$(MAKE) /f makefile_fmt_vc FMT=Arj
	$(MAKE) /f makefile_fmt_vc FMT=Cab
	$(MAKE) /f makefile_fmt_vc FMT=Ha
	$(MAKE) /f makefile_fmt_vc FMT=Lzh
	$(MAKE) /f makefile_fmt_vc FMT=Rar
	$(MAKE) /f makefile_fmt_vc FMT=TarGz
	$(MAKE) /f makefile_fmt_vc FMT=Zip
	@copy /Y Custom.ini $(OUTDIR)\Formats
